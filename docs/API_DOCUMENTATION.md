# Документация API для бота

## Общая информация

API построено на Django REST Framework и предоставляет возможность взаимодействия с ботом через HTTP запросы.
Все запросы к API возвращают данные в формате JSON с ключом `success`, указывающим на успешность выполнения операции.

## Аутентификация

В API используется два способа аутентификации:

1. **TelegramIDAuthentication** - аутентификация по Telegram ID, передаваемом в заголовке `X-Telegram-ID`. Используется для эндпоинтов, требующих идентификации пользователя.
2. **Прямой доступ** - для некоторых эндпоинтов доступен прямой доступ без аутентификации, но с передачей `telegram_id` в параметрах запроса (GET) или теле запроса (POST).

## Основные эндпоинты

### Регистрация и авторизация

#### POST /api/auth/register/
Регистрация нового пользователя

Запрос:
```json
{
    "telegram_id": 123456789,
    "username": "username",
    "first_name": "Имя",
    "last_name": "Фамилия",
    "language_code": "ru",
    "chat_id": 123456789,
    "contact": "+79001234567",
    "referral_code": "CODE123" // опционально
}
```

Успешный ответ (201 Created):
```json
{
    "success": true,
    "message": "Пользователь успешно зарегистрирован",
    "user_id": 1,
    "telegram_id": 123456789,
    "requests_left": 10 // Начальное кол-во запросов
}
```

#### POST /api/auth/login/
Получение информации о пользователе при входе (или проверке существования)

Запрос:
```json
{
    "telegram_id": 123456789
}
```

Успешный ответ (200 OK):
```json
{
    "success": true,
    "user_id": 1,
    "telegram_id": 123456789,
    "username": "username",
    "requests_left": 5 // Текущее кол-во запросов
}
```

### Запросы пользователя

#### GET /api/check-requests/
Проверка доступных запросов. Требуется аутентификация (`X-Telegram-ID` или `telegram_id` в параметрах).

Пример запроса:
`/api/check-requests/?telegram_id=123456789`

Успешный ответ (200 OK):
```json
{
    "success": true,
    "requests_left": 5,
    "can_make_request": true
}
```

#### POST /api/use-request/ (УСТАРЕЛ)
Этот эндпоинт больше не используется для чатов. Списание запросов происходит при отправке сообщения через `/api/chats/{chat_id}/messages/create/`.

### Промокоды

#### POST /api/validate-promo/
Проверка валидности промокода. Требуется аутентификация.

Запрос:
```json
{
    "code": "PROMO2023",
    "plan_id": 1, // опционально
    "telegram_id": 123456789 // если не используется заголовок
}
```

Успешный ответ (200 OK):
```json
{
    "success": true,
    "promo": {
        "id": 1,
        "code": "PROMO2023",
        "discount_type": "percent",
        "discount_value": 10.0,
        "bonus_requests": 5
    },
    "discount_amount": 100.0, // Рассчитанная скидка для plan_id=1
    "price_after_discount": 900.0
}
```

### Информация о пользователе

#### GET /api/me/
Получение информации о пользователе. Требуется аутентификация.

Пример запроса:
`/api/me/?telegram_id=123456789`

Успешный ответ (200 OK):
```json
{
    "success": true,
    "user": {
        "user_id": 1,
        "telegram_id": 123456789,
        "username": "username",
        // ... другие поля пользователя ...
        "requests_left": 4
    },
    "active_plan": { // Информация об активном плане (если есть)
        "id": 1,
        "plan_details": {
            "name": "Премиум",
            // ... другие детали плана ...
        },
        "expired_at": "2023-01-31T12:30:00Z"
    },
    "statistics": { // Статистика пользователя
        "total_requests": 10,
        "total_tokens": 1500
        // ... другая статистика ...
    }
}
```

#### GET /api/me/history/
Получение истории использования запросов (не сообщений чата). Требуется аутентификация.

Пример запроса:
`/api/me/history/?telegram_id=123456789&page=1&per_page=10`

Параметры:
- `page` (int, опционально): Номер страницы (по умолчанию 1)
- `per_page` (int, опционально): Количество записей на странице (по умолчанию 20)

Успешный ответ (200 OK):
```json
{
    "success": true,
    "history": [
        {
            "id": 10,
            "request_type": "text",
            "ai_model": "gpt-4",
            "tokens_used": 150,
            "request_date": "2023-01-05T15:30:00Z",
            // ... другие поля RequestUsage ...
        },
        // ...
    ],
    "pagination": {
        "page": 1,
        "per_page": 10,
        "total": 10,
        "total_pages": 1
    }
}
```

### Рефералы

#### GET /api/referrals/
Получение информации о рефералах пользователя. Требуется аутентификация.

Пример запроса:
`/api/referrals/?telegram_id=123456789`

Успешный ответ (200 OK):
```json
{
    "success": true,
    "referrals": [
        {
            "user_id": 2,
            "username": "referral1",
            // ... информация о реферале ...
            "bonus_requests_added": 5
        },
        // ...
    ],
    "total_count": 2,
    "total_earnings": 45.0
}
```

### Управление чатами

#### GET /api/chats/
Получение списка чатов пользователя. Требуется аутентификация.

Пример запроса:
`/api/chats/?telegram_id=123456789`

Успешный ответ (200 OK):
```json
{
    "success": true,
    "chats": [
        {
            "id": 1,
            "user": 1,
            "title": "Обсуждение проекта X",
            "created_at": "2023-10-26T10:00:00Z",
            "updated_at": "2023-10-26T10:05:00Z"
        },
        {
            "id": 2,
            "user": 1,
            "title": "Новый чат",
            "created_at": "2023-10-27T11:00:00Z",
            "updated_at": "2023-10-27T11:00:00Z"
        }
    ]
}
```

#### POST /api/chats/
Создание нового чата. Требуется аутентификация.

Запрос:
```json
{
    "title": "Мой новый чат", // опционально, по умолчанию "Новый чат"
    "telegram_id": 123456789 // если не используется заголовок
}
```

Успешный ответ (201 Created):
```json
{
    "success": true,
    "chat": {
        "id": 3,
        "user": 1,
        "title": "Мой новый чат",
        "created_at": "2023-10-28T12:00:00Z",
        "updated_at": "2023-10-28T12:00:00Z"
    }
}
```

#### DELETE /api/chats/{chat_id}/
Удаление чата. Требуется аутентификация. `{chat_id}` заменяется на ID чата.

Пример запроса:
`DELETE /api/chats/3/?telegram_id=123456789`

Успешный ответ (204 No Content):
Тело ответа пустое.

#### GET /api/chats/{chat_id}/messages/
Получение истории сообщений для конкретного чата. Требуется аутентификация.

Пример запроса:
`GET /api/chats/1/messages/?telegram_id=123456789`

Успешный ответ (200 OK):
```json
{
    "success": true,
    "messages": [
        {
            "id": 1,
            "role": "user",
            "content": "Привет! Расскажи о себе.",
            "timestamp": "2023-10-26T10:05:00Z"
            // model_used и tokens_used будут null для user
        },
        {
            "id": 2,
            "role": "assistant",
            "content": "Привет! Я большая языковая модель...",
            "model_used": "gpt-4",
            "tokens_used": 50,
            "timestamp": "2023-10-26T10:05:05Z"
        }
        // ... другие сообщения ...
    ]
}
```

#### POST /api/chats/{chat_id}/messages/create/
Отправка сообщения пользователя в чат, получение ответа от ИИ и списание 1 запроса. Требуется аутентификация.

Пример запроса:
`POST /api/chats/1/messages/create/`

Заголовки (если не используется telegram_id в теле):
`X-Telegram-ID: 123456789`

Тело запроса:
```json
{
    "content": "Как мне использовать ваше API?"
    // "telegram_id": 123456789 // если не используется заголовок
}
```

Успешный ответ (200 OK):
```json
{
    "success": true,
    "message": { // Содержит только что сгенерированное сообщение ассистента
        "id": 3,
        "role": "assistant",
        "content": "Для использования API, вам нужно...",
        "model_used": "gpt-4",
        "tokens_used": 120,
        "timestamp": "2023-10-28T12:10:15Z"
    }
}
```

Ответ при ошибке (например, закончились запросы, 403 Forbidden):
```json
{
    "success": false,
    "message": "У вас закончились запросы. Пожалуйста, пополните баланс.",
    "requests_left": 0
}
```

Ответ при ошибке ИИ (503 Service Unavailable):
```json
{
    "success": false,
    "message": "Ошибка при обращении к ИИ: [текст ошибки]"
}
```

### Прямой доступ без аутентификации

#### GET /api/telegram/requests/?telegram_id=123456789
Проверка доступных запросов по telegram_id (не требует аутентификации)

Успешный ответ:
```json
{
    "success": true,
    "telegram_id": 123456789,
    "requests_left": 4,
    "can_make_request": true
}
```

#### POST /api/telegram/use-request/
Использование запроса по telegram_id (не требует аутентификации). **Устарел для чатов.**

#### GET /api/telegram/user-info/?telegram_id=123456789
Получение информации о пользователе по telegram_id (не требует аутентификации)

Успешный ответ:
```json
{
    "success": true,
    "user": {
        "user_id": 1,
        // ... базовая информация о пользователе ...
        "requests_left": 3
    },
    "active_plan": {
        "plan_name": "Премиум",
        // ... базовая информация о плане ...
    }
}
```

## Коды ошибок

| Код | Описание |
|-----|----------|
| 400 | Bad Request: Ошибка в параметрах запроса (неверный формат JSON, отсутствуют обязательные поля) |
| 401 | Unauthorized: Пользователь не авторизован (неверный или отсутствует `X-Telegram-ID`) |
| 403 | Forbidden: Доступ запрещен (например, недостаточно запросов, попытка удалить чужой чат) |
| 404 | Not Found: Ресурс не найден (неверный URL, пользователь или чат не найдены) |
| 409 | Conflict: Конфликт (например, пользователь уже существует при регистрации) |
| 500 | Internal Server Error: Внутренняя ошибка сервера |
| 503 | Service Unavailable: Ошибка при взаимодействии с внешним сервисом (например, OpenAI API) | 